---
- name: TLS | Acme | Check if domain names set properly
  fail:
    msg: "Variable acme_domains with domain names list should be set"
  when: tls.acme_domains | length == 0

- name: TLS | Pre-installation | Install prerequisites
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - git
    - curl
    - socat

- name: TLS | Installation | Checkout acme.sh repo
  git:
    repo: https://github.com/Neilpang/acme.sh.git
    dest: /root/acme.sh

- name: TLS | Installation | Install acme.sh to the system
  command: ./acme.sh --install
  args:
    chdir: /root/acme.sh
    creates: /root/.acme.sh/acme.sh

- name: TLS | Installation | Check for autogenerated crontab entry
  shell:
    cmd: |
      crontab -l | egrep -q '.*acme.sh.*dev/null.*'
  changed_when: false
  failed_when: false
  register: crontab_default_acme_entry

- name: TLS | Installation | Change autogenerated crontab entry
  shell:
    cmd: |
      crontab -l | sed -e 's:.*acme.sh.*:10 0 * * * /root/.acme.sh/acme.sh --cron --home /root/.acme.sh:' | crontab -
  when: crontab_default_acme_entry.rc == 0

- name: TLS | Installation | Convert domains list to appropriate format
  set_fact:
    # To understand this, look at https://medium.com/@george.shuklin/data-manipulation-in-ansible-bab8eb7d7f93
    acme_domains: '{{ tls.acme_domains | map("regex_replace", "^(.*)$", " -d \1") | list | join(" ") | safe }}'

- name: TLS | Installation | Show resulting domains line
  debug:
    msg: "{{ acme_domains }}"

- name: TLS | Installation | Create directory for certificates
  file:
    path: "{{ tls.target_dir }}/{{ tls.acme_domains[0] }}"
    state: directory

- name: TLS | Installation | Create hooks string
  set_fact:
    acme_hooks: '--pre-hook "{{ tls.acme_pre_hook }}" --post-hook "{{ tls.acme_post_hook }}"'
  when: tls.acme_hooks

- name: TLS | Certificate Issue | Create new certs in standalone mode
  shell:
    cmd: |
      ./acme.sh --issue --{{ tls.acme_challenge }} {{ acme_domains }} \
      --key-file /etc/ssl_certs/{{ tls.acme_domains[0] }}/private.pem \
      --fullchain-file /etc/ssl_certs/{{ tls.acme_domains[0] }}/fullchain.pem \
      {{ acme_hooks }}
  args:
    chdir: /root/acme.sh
  when: tls.acme_challenge == "standalone"
  register: ch_ex
  changed_when: ch_ex.rc != 2
  failed_when: False

- name: TLS | Certificate Issue | Create new certs in DNS mode
  shell:
    cmd: |
      ./acme.sh --issue --dns {{ tls.acme_ch_dns_type }} {{ acme_domains }} \
      --key-file /etc/ssl_certs/{{ tls.acme_domains[0] }}/private.pem \
      --fullchain-file /etc/ssl_certs/{{ tls.acme_domains[0] }}/fullchain.pem \
      --post-hook "{{ tls.acme_post_hook }}"
  args:
    chdir: /root/acme.sh
  environment: "{{ tls.acme_ch_dns_vars }}"
  when: tls.acme_challenge == "dns"
  register: ch_ex
  failed_when: False

- name: TLS | Postinstall | Ensure prehook for cron
  lineinfile:
    path: "/root/.acme.sh/{{ tls.acme_domains[0] }}/{{ tls.acme_domains[0] }}.conf"
    regexp: '^Le_PreHook='
    line: 'Le_PreHook="{{ tls.acme_pre_hook }}"'
  when: tls.acme_hooks

- name: TLS | Postinstall | Ensure posthook for cron
  lineinfile:
    path: "/root/.acme.sh/{{ tls.acme_domains[0] }}/{{ tls.acme_domains[0] }}.conf"
    regexp: '^Le_PostHook='
    line: 'Le_PostHook="{{ tls.acme_post_hook }}"'
  when: tls.acme_hooks

- name: TLS | Postcheck | Ensure certs placement
  stat:
    path: /etc/ssl_certs/{{ tls.acme_domains[0] }}/private.pem
  register: private_key

- name: TLS | Postcheck | Forcibly place keypair to target dir
  file:
    src: '{{ item["src"] }}'
    dest: ' {{ item["dest"] }}'
    state: link
  with_items:
    - { src: "/root/.acme.sh/{{ tls.acme_domains[0] }}/{{ tls.acme_domains[0] }}.key",
        dest: "{{ tls.target_dir }}/{{ tls.acme_domains[0] }}/private.pem" }
    - { src: "/root/.acme.sh/{{ tls.acme_domains[0] }}/fullchain.cer",
        dest: "{{ tls.target_dir }}/{{ tls.acme_domains[0] }}/fullchain.pem" }
  when: not private_key.stat.exists

- name: TLS | Deploy | Create HAProxy chain
  shell:
    cmd: |
      cat \
      /root/.acme.sh/{{ tls.acme_domains[0] }}/fullchain.cer \
      /root/.acme.sh/{{ tls.acme_domains[0] }}/{{ tls.acme_domains[0] }}.key \
      > {{ tls.target_dir }}/{{ tls.acme_domains[0] }}/{{ tls.target_bundle_name }}
  when: tls.target_format == 'haproxy' and tls.type == 'local'

- name: TLS | Deploy | Create HAProxy chain
  shell:
    cmd: |
      ./acme.sh --deploy {{ acme_domains }} \
      --deploy-hook haproxy
  args:
    chdir: /root/acme.sh
  environment:
    DEPLOY_HAPROXY_PEM_PATH: "{{ tls.target_dir }}/{{ tls.acme_domains[0] }}"
    DEPLOY_HAPROXY_RELOAD: "systemctl reload haproxy"
  when: tls.target_format == 'haproxy' and tls.type == 'acme'

- name: TLS | Postcheck | Fail if got real error on cert issuing time
  fail:
    msg: "Got an error while issue certificate: \n {{ ch_ex.stdout }}"
  when: ch_ex is defined and ch_ex.rc is defined and ch_ex.rc != 0 and not 'Domains not changed' in ch_ex.stdout
